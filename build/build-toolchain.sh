#! /bin/sh

set -o errexit
set -o nounset
set -o xtrace

sudo apt-get update

export ARCH=${ARCH:-"x86_64"}
case $ARCH in
    "aarch64")
        export TARGET_TRIPLET=aarch64-unknown-linux-gnu
        ;;
    "arm")
        export TARGET_TRIPLET=arm-unknown-linux-gnueabi
        ;;
    "x86_64")
        export TARGET_TRIPLET=x86_64-unknown-linux-gnu
        ;;
esac
echo "target: $TARGET_TRIPLET"

export BUILDS=`pwd`/lordos_builds
mkdir -p $BUILDS
export CODE=$BUILDS/code
mkdir -p $CODE

cd $CODE
export CROSSTOOL_CODE=$CODE/crosstool-ng
rm -rf $CROSSTOOL_CODE || echo "no need to remove $CROSSTOOL_CODE"
git clone http://github.com/crosstool-ng/crosstool-ng
if [ -x "`command -v ct-ng`" ]; then
    echo "no need to build ct-ng"
else
    # Dependencies already installed on GitHub action
    # sudo apt-get --yes install build-essential autoconf bison flex libncurses-dev texinfo unzip python-dev
    # Dependencies of crosstool-ng
    sudo apt-get --yes install help2man libtool-bin libtool-doc
    cd $CROSSTOOL_CODE
    ./bootstrap
    ./configure
    make
    sudo make install
fi
ct-ng show-$TARGET_TRIPLET

# build crosstool-ng toolchain
export CROSSTOOL_BUILD=$BUILDS/crosstool-ng
rm -rf $CROSSTOOL_BUILD || echo "no need to remove $CROSSTOOL_BUILD"
mkdir -p $CROSSTOOL_BUILD
cd $CROSSTOOL_BUILD
ct-ng $TARGET_TRIPLET
# ct-ng x86_64-unknown-linux-gnu
# mv ../crosstool-ng.config .config
ct-ng build

# test crosstool-ng toolchain
export CROSSTOOL_TEST=$BUILDS/crosstool-ng-test
rm -rf $CROSSTOOL_TEST || echo "no need to remove $CROSSTOOL_TEST"
mkdir -p $CROSSTOOL_TEST
cd $CROSSTOOL_TEST
export XTOOLS_TEST=xtools_test
cat <<EOF > $XTOOLS_TEST.c
#include <stdio.h>
int main(int argc, char*argv[])
{
    printf("Genuinely generated by the toolchain\n");
}
EOF
export TOOLCHAIN_DIR=$HOME/x-tools/$TARGET_TRIPLET
export PATH="$PATH:$TOOLCHAIN_DIR/bin"
export GCC=$TARGET_TRIPLET-gcc
$GCC $XTOOLS_TEST.c -o $XTOOLS_TEST
chmod +x $XTOOLS_TEST
readelf -d $XTOOLS_TEST
readelf -l $XTOOLS_TEST
rm $XTOOLS_TEST
$GCC -static $XTOOLS_TEST.c -o $XTOOLS_TEST

# build tar
cd $HOME/x-tools
export KERNEL_VERSION=`ct-ng show-$TARGET_TRIPLET | grep ': linux-' | cut -d '-' -f 2`
tar zcf $TARGET_TRIPLET-kernel-$KERNEL_VERSION.tgz ./$TARGET_TRIPLET

